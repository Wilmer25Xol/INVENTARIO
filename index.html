<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventario de Madera ‚Äî Kardex PT (Compartido)</title>
  <style>
    :root{ --bg:#0f172a; --card:#0b1220; --line:#1f2937; --muted:#93a3b8; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --blue:#3b82f6 }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#020617 70%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:12px}
    h1{margin:0 0 6px;font-size:clamp(20px,4vw,28px)}
    .note{color:var(--muted);font-size:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{flex:1 1 360px;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    label{font-size:12px;color:var(--muted)}
    input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#070c16;color:var(--text)}
    input:focus,select:focus{outline:2px solid var(--blue);border-color:var(--blue)}
    .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
    .col-2{grid-column:span 2}.col-3{grid-column:span 3}.col-6{grid-column:span 6}
    button{border:0;border-radius:999px;padding:10px 14px;cursor:pointer;background:#1f2937;color:var(--text)}
    .primary{background:var(--accent);color:#052e16;font-weight:800}
    .danger{background:var(--danger);color:#fff}
    .ghost{background:#0b1220}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.05em}
    tfoot td{font-weight:800}
    .right{text-align:right}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .badge{font-size:12px;background:#094; padding:2px 8px;border-radius:999px}
    .tests{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;white-space:pre-wrap;background:#0a1220;border:1px solid #1f2937;border-radius:12px;padding:8px;color:#c7d2fe}
    details[open] > summary::marker{content:""}
    details > summary{cursor:pointer; list-style:none}
    @media(max-width:960px){.grid{grid-template-columns:repeat(2,1fr)}.col-2,.col-3,.col-6{grid-column:span 2}}
  </style>
  <!-- SheetJS para generar Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <!-- Firebase compat (Realtime Database) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="row" style="align-items:flex-end;justify-content:space-between">
      <div>
        <h1>Inventario de Madera ‚Äî Kardex en PT (Compartido)</h1>
        <div class="note">Registra <b>ingresos</b> y <b>salidas</b> por especie, lote, ubicaci√≥n y <b>medidas (cm)</b>. Calcula <b>pie tablar (PT)</b> y saldos agrupados. Datos sincronizados en la nube. Exporta a <b>Excel (.xlsx)</b>.</div>
      </div>
      <div class="toolbar">
        <button id="btn-export-local" class="primary" title="Descargar Excel">Descargar Excel (.xlsx)</button>
      </div>
    </header>

    <!-- Formulario de movimiento -->
    <section class="card" style="margin-top:12px">
      <form id="form" class="grid">
        <div class="col-2">
          <label>Fecha</label>
          <input type="date" id="fecha" />
        </div>
        <div>
          <label>Tipo</label>
          <select id="tipo">
            <option value="Ingreso">Ingreso</option>
            <option value="Salida">Salida</option>
          </select>
        </div>
        <div>
          <label>Lote</label>
          <input type="text" id="lote" placeholder="L-2025-09-01" />
        </div>
        <div class="col-2">
          <label>Especie</label>
          <select id="especie">
            <option value="PALO BLANCO">PALO BLANCO</option>
            <option value="PINO">PINO</option>
            <option value="CAOBA">CAOBA</option>
            <option value="ENCINO">ENCINO</option>
            <option value="LIQUIDAMBAR">LIQUIDAMBAR</option>
            <option value="TECA">TECA</option>
            <option value="CIPRES">CIPRES</option>
            <option value="EUCALIPTOS">EUCALIPTOS</option>
            <option value="OTROS">OTROS</option>
          </select>
        </div>
        <div>
          <label>Ubicaci√≥n</label>
          <select id="ubicacion">
            <option value="PATIO OFICINA">PATIO OFICINA</option>
            <option value="PATIO CEIBA">PATIO CEIBA</option>
            <option value="PATIO SECADORA">PATIO SECADORA</option>
            <option value="ADENTRO DE CARPINTERIA">ADENTRO DE CARPINTERIA</option>
            <option value="GALERA">GALERA</option>
            <option value="OTRO">OTRO</option>
          </select>
        </div>

        <div>
          <label>Largo (cm)</label>
          <input type="number" id="largo" min="0" step="0.01" />
        </div>
        <div>
          <label>Ancho (cm)</label>
          <input type="number" id="ancho" min="0" step="0.01" />
        </div>
        <div>
          <label>Espesor (cm)</label>
          <input type="number" id="espesor" min="0" step="0.01" />
        </div>
        <div>
          <label>Cantidad (piezas)</label>
          <input type="number" id="cantidad" min="1" step="1" />
        </div>
        <div>
          <label>Precio (Q) opcional</label>
          <input type="number" id="precio" min="0" step="0.01" />
        </div>
        <div class="col-6">
          <label>Observaciones</label>
          <input type="text" id="obs" placeholder="Proveedor, calidad, gu√≠a, etc." />
        </div>
        <div class="col-6 toolbar">
          <button type="button" id="btn-add" class="primary">Agregar movimiento (nube)</button>
          <button type="button" id="btn-clear-cloud" class="danger">Vaciar TODO (nube)</button>
        </div>
        <div class="col-6 note">Las medidas son en <b>cm</b>. El sistema calcula PT por pieza y por movimiento. 1 PT = 144 in¬≥ (1 in = 2.54 cm).</div>
      </form>
    </section>

    <!-- Movimientos -->
    <section class="card" style="margin-top:12px">
      <div style="overflow:auto">
        <table id="tbl-mov">
          <thead>
            <tr>
              <th>#</th><th>Fecha</th><th>Tipo</th><th>Especie</th><th>Lote</th><th>Ubicaci√≥n</th>
              <th>Largo</th><th>Ancho</th><th>Espesor</th><th>Qty</th>
              <th>PT/pza</th><th>PT mov</th><th>Precio</th><th>Subtotal</th><th>Obs</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="9" class="right">Totales</td>
              <td id="movQty">0</td>
              <td></td>
              <td id="movPT">0.000</td>
              <td></td>
              <td id="movQ">0.00</td>
              <td></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- Saldos actuales agrupados -->
    <section class="card" style="margin-top:12px">
      <div class="toolbar" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><b>Saldos actuales</b> <span class="note">(agrupado por especie + lote + ubicaci√≥n + medidas)</span></div>
        <div class="badge" id="badgeItems">0 √≠tems</div>
      </div>
      <div style="overflow:auto">
        <table id="tbl-saldo">
          <thead>
            <tr>
              <th>Especie</th><th>Lote</th><th>Ubicaci√≥n</th>
              <th>Largo</th><th>Ancho</th><th>Espesor</th>
              <th>Qty saldo</th><th>PT/pza</th><th>PT saldo</th><th>Valor Q (opcional)</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="6" class="right">Totales</td>
              <td id="saldoQty">0</td>
              <td></td>
              <td id="saldoPT">0.000</td>
              <td id="saldoQ">0.00</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <details style="margin-top:12px">
      <summary class="note">Ver pruebas autom√°ticas (unit tests)</summary>
      <div id="test-log" class="tests"></div>
    </details>

    <p class="note">Los saldos se calculan tipo <b>Kardex</b> simple (cantidad). Si usas precios, se acumula subtotal por movimiento (no m√©todo de valoraci√≥n espec√≠fico). Podemos implementar <b>Promedio Ponderado</b> o <b>PEPS</b> si lo deseas.</p>
  </div>

  <script>
    // ===== Utilidades =====
    const $ = s=>document.querySelector(s);
    const round = (n,d=3)=>Number.parseFloat(n||0).toFixed(d);
    const cmToIn = cm => (cm||0)/2.54;
    const ptPerPiece = (lcm,acm,ecm)=> (cmToIn(lcm)*cmToIn(acm)*cmToIn(ecm))/144;

    // ===== Estado =====
    let movimientos = [];
    const keyOf = r => [r.especie, r.lote, r.ubicacion, r.largo, r.ancho, r.espesor].join('|');

    // ===== Firebase (compartido) =====
    const firebaseConfig = {
      apiKey: "PEGAR_API_KEY",
      authDomain: "PEGAR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://PEGAR_PROJECT_ID-default-rtdb.firebaseio.com",
      projectId: "PEGAR_PROJECT_ID",
      storageBucket: "PEGAR_PROJECT_ID.appspot.com",
      messagingSenderId: "PEGAR_SENDER_ID",
      appId: "PEGAR_APP_ID"
    };

    let fbApp, dbRef;
    function initFirebase(){
      try{
        fbApp = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        dbRef = db.ref('kardex_madera/movimientos');
        bindRealtime(dbRef);
      }catch(e){ console.error(e); alert('No se pudo inicializar Firebase. Revisa el config.'); }
    }

    function bindRealtime(ref){
      movimientos = [];
      ref.off();
      ref.on('child_added', snap=>{ movimientos.push({ id:snap.key, ...snap.val() }); render(); });
      ref.on('child_changed', snap=>{ const idx = movimientos.findIndex(x=>x.id===snap.key); if(idx>-1){ movimientos[idx] = { id:snap.key, ...snap.val() }; render(); }});
      ref.on('child_removed', snap=>{ const idx = movimientos.findIndex(x=>x.id===snap.key); if(idx>-1){ movimientos.splice(idx,1); render(); }});
    }

    function leerForm(){
      const r = {
        fecha: $('#fecha').value || new Date().toISOString().slice(0,10),
        tipo: $('#tipo').value,
        lote: $('#lote').value.trim(),
        especie: $('#especie').value,
        ubicacion: $('#ubicacion').value,
        largo: Number($('#largo').value),
        ancho: Number($('#ancho').value),
        espesor: Number($('#espesor').value),
        cantidad: Number($('#cantidad').value),
        precio: Number($('#precio').value)||null,
        obs: $('#obs').value.trim()
      };
      if(!r.largo||!r.ancho||!r.espesor||!r.cantidad||!r.especie){
        alert('Completa especie, medidas y cantidad.');
        return null;
      }
      r.pt_pieza = ptPerPiece(r.largo, r.ancho, r.espesor);
      const signo = r.tipo==='Salida' ? -1 : 1;
      r.pt_mov = r.pt_pieza * r.cantidad * signo;
      r.subtotal = r.precio ? r.precio * r.cantidad * (signo>0?1:-1) : null;
      return r;
    }

    function agregar(){
      const r = leerForm(); if(!r) return;
      if(!dbRef){ alert('Base en nube no inicializada.'); return; }
      const payload = { ...r, createdAt: Date.now() };
      dbRef.push(payload, (err)=>{
        if(err){ alert('Error al guardar en la nube'); console.error(err); }
        else { $('#form').reset(); $('#fecha').value = new Date().toISOString().slice(0,10); }
      });
    }

    // üîß FIX: funci√≥n sin llave extra
    function borrarId(id){
      if(!dbRef) return;
      if(confirm('¬øEliminar movimiento?')) dbRef.child(id).remove();
    }

    function render(){
      // Movimientos
      const tbody = $('#tbl-mov tbody'); tbody.innerHTML = '';
      let tQty=0, tPT=0, tQ=0;
      movimientos.forEach((m,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${m.fecha}</td>
          <td>${m.tipo}</td>
          <td>${m.especie}</td>
          <td>${m.lote}</td>
          <td>${m.ubicacion}</td>
          <td>${m.largo}</td>
          <td>${m.ancho}</td>
          <td>${m.espesor}</td>
          <td>${m.tipo==='Salida'?-m.cantidad:m.cantidad}</td>
          <td>${round(m.pt_pieza)}</td>
          <td>${round(m.pt_mov)}</td>
          <td>${m.precio? m.precio.toFixed(2): ''}</td>
          <td>${m.subtotal!==null? m.subtotal.toFixed(2): ''}</td>
          <td>${m.obs||''}</td>
          <td><button class="danger" onclick="borrarId('${m.id}')">Borrar</button></td>`;
        tbody.appendChild(tr);
        tQty += (m.tipo==='Salida'?-m.cantidad:m.cantidad);
        tPT  += m.pt_mov; tQ += m.subtotal||0;
      });
      $('#movQty').textContent = tQty;
      $('#movPT').textContent  = round(tPT);
      $('#movQ').textContent   = tQ.toFixed(2);

      // Saldos agrupados
      const map = new Map();
      for(const m of movimientos){
        const k = keyOf(m);
        if(!map.has(k)) map.set(k,{...m, cantidad:0, pt_pieza:m.pt_pieza, pt_saldo:0, valor:0});
        const it = map.get(k);
        it.cantidad += (m.tipo==='Salida'?-m.cantidad:m.cantidad);
        it.pt_saldo += m.pt_mov;
        it.valor    += m.subtotal||0; // acumulado simple
      }
      const saldoBody = $('#tbl-saldo tbody'); saldoBody.innerHTML = '';
      let sQty=0, sPT=0, sQ=0, items=0;
      for(const it of map.values()){
        if(it.cantidad===0 && Math.abs(it.pt_saldo)<1e-9) continue; // ocultar cero
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.especie}</td>
          <td>${it.lote}</td>
          <td>${it.ubicacion}</td>
          <td>${it.largo}</td>
          <td>${it.ancho}</td>
          <td>${it.espesor}</td>
          <td>${it.cantidad}</td>
          <td>${round(it.pt_pieza)}</td>
          <td>${round(it.pt_saldo)}</td>
          <td>${it.valor? it.valor.toFixed(2): ''}</td>`;
        saldoBody.appendChild(tr);
        sQty += it.cantidad; sPT += it.pt_saldo; sQ += it.valor||0; items++;
      }
      $('#saldoQty').textContent = sQty;
      $('#saldoPT').textContent  = round(sPT);
      $('#saldoQ').textContent   = sQ.toFixed(2);
      $('#badgeItems').textContent = `${items} √≠tems`;

      // Cach√© local de vista
      localStorage.setItem('kardex_madera_cache', JSON.stringify(movimientos.map(({id, ...rest})=>rest)));
    }

    // ===== Acciones nube =====
    function vaciarNube(){ if(!dbRef) return; if(confirm('¬øEliminar TODO de la nube?')) dbRef.remove(); }

    // ===== Exportaci√≥n a Excel (.xlsx) =====
    function buildWorkbook(){
      const mov = movimientos.map((m,i)=>({
        N:i+1, Fecha:m.fecha, Tipo:m.tipo, Especie:m.especie, Lote:m.lote, Ubicaci√≥n:m.ubicacion,
        Largo_cm:m.largo, Ancho_cm:m.ancho, Espesor_cm:m.espesor, Cantidad: m.tipo==='Salida'?-m.cantidad:m.cantidad,
        PT_por_pieza: Number(round(m.pt_pieza)), PT_mov: Number(round(m.pt_mov)), Precio_Q: m.precio??'', Subtotal_Q:m.subtotal??'', Obs:m.obs??''
      }));
      const map = new Map();
      for(const m of movimientos){ const k=keyOf(m); if(!map.has(k)) map.set(k,{...m, cantidad:0, pt_pieza:m.pt_pieza, pt_saldo:0, valor:0});
        const it=map.get(k); it.cantidad += (m.tipo==='Salida'?-m.cantidad:m.cantidad); it.pt_saldo += m.pt_mov; it.valor += m.subtotal||0; }
      const sal = Array.from(map.values()).filter(x=>x.cantidad!==0 || Math.abs(x.pt_saldo)>1e-9).map((it)=>({
        Especie:it.especie, Lote:it.lote, Ubicaci√≥n:it.ubicacion, Largo_cm:it.largo, Ancho_cm:it.ancho, Espesor_cm:it.espesor,
        Cantidad_saldo:it.cantidad, PT_por_pieza:Number(round(it.pt_pieza)), PT_saldo:Number(round(it.pt_saldo)), Valor_Q: it.valor||''
      }));
      const wb = XLSX.utils.book_new();
      const ws1 = XLSX.utils.json_to_sheet(mov);
      const ws2 = XLSX.utils.json_to_sheet(sal);
      XLSX.utils.book_append_sheet(wb, ws1, 'Movimientos');
      XLSX.utils.book_append_sheet(wb, ws2, 'Saldos');
      return wb;
    }

    function downloadXLSX(){
      const wb = buildWorkbook();
      const name = `kardex_madera_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, name);
    }

    // ===== Pruebas b√°sicas (no tocan la nube) =====
    function runTests(){
      const logs = [];
      function ok(name, cond){ logs.push(`${cond? '‚úÖ':'‚ùå'} ${name}`); if(!cond) console.error('Test failed:', name); }
      // 1) ptPerPiece: 2.54cm x 2.54cm x 2.54cm = 1in x1in x1in / 144 = 1/144 bf
      const pt1 = ptPerPiece(2.54,2.54,2.54); ok('ptPerPiece(2.54cm¬≥) ‚âà 1/144', Math.abs(pt1 - (1/144)) < 1e-6);
      // 2) Signo de movimiento
      const ingreso = {tipo:'Ingreso', largo:254, ancho:2.54, espesor:2.54, cantidad:10};
      const salida  = {tipo:'Salida',  largo:254, ancho:2.54, espesor:2.54, cantidad:10};
      ingreso.pt_pieza = ptPerPiece(ingreso.largo, ingreso.ancho, ingreso.espesor);
      salida.pt_pieza  = ptPerPiece(salida.largo,  salida.ancho,  salida.espesor);
      ingreso.pt_mov = ingreso.pt_pieza * ingreso.cantidad; salida.pt_mov = -salida.pt_pieza * salida.cantidad;
      ok('Ingreso positivo', ingreso.pt_mov > 0);
      ok('Salida negativa', salida.pt_mov < 0);
      // 3) keyOf agrupa
      const kA = keyOf({especie:'PINO',lote:'L1',ubicacion:'PATIO',largo:100,ancho:10,espesor:2});
      const kB = keyOf({especie:'PINO',lote:'L1',ubicacion:'PATIO',largo:100,ancho:10,espesor:2});
      ok('keyOf igual para mismo item', kA === kB);
      // 4) Totales de ejemplo
      const ejemplo = [
        {tipo:'Ingreso', largo:254,ancho:2.54,espesor:2.54,cantidad:10},
        {tipo:'Salida',  largo:254,ancho:2.54,espesor:2.54,cantidad:4}
      ];
      const tot = ejemplo.reduce((acc,m)=>{const s=m.tipo==='Salida'?-1:1; const p=ptPerPiece(m.largo,m.ancho,m.espesor); return {qty:acc.qty+s*m.cantidad, pt:acc.pt+s*m.cantidad*p};},{qty:0,pt:0});
      ok('Kardex simple acumula qty', tot.qty === 6);
      ok('Kardex simple acumula PT', tot.pt > 0);
      $('#test-log').textContent = logs.join('\n');
    }

    // ===== Eventos =====
    $('#btn-add').onclick = agregar;
    $('#btn-clear-cloud').onclick = vaciarNube;
    $('#btn-export-local').onclick = downloadXLSX;

    // Inicializaci√≥n
    $('#fecha').value = new Date().toISOString().slice(0,10);
    runTests();
    initFirebase();
  </script>
</body>
</html>
